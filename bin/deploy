#!/usr/bin/env bash
set -e

cd "$(dirname "$0")/.."

# Load environment variables from .env.deploy if exists
if [ -f .env.deploy ]; then
  set -a
  source .env.deploy
  set +a
fi

# Required environment variables
: "${CAPROVER_URL:?Error: CAPROVER_URL not set}"
: "${CAPROVER_PASSWORD:?Error: CAPROVER_PASSWORD not set}"
: "${CAPROVER_APP:=tabdevs}"

BRANCH=${1:-main}

echo "Deploying branch '$BRANCH' to $CAPROVER_APP..."

# Create tarball of the repo
TAR_FILE=$(mktemp /tmp/deploy-XXXXXX.tar)
git archive --format=tar "$BRANCH" > "$TAR_FILE"

# Get auth token (use jq to properly escape password in JSON)
LOGIN_PAYLOAD=$(jq -n --arg pass "$CAPROVER_PASSWORD" '{"password": $pass}')
LOGIN_RESPONSE=$(curl -s -X POST "$CAPROVER_URL/api/v2/login" \
  -H "Content-Type: application/json" \
  -H "x-namespace: captain" \
  -d "$LOGIN_PAYLOAD")

TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.data.token // empty')

if [ -z "$TOKEN" ]; then
  echo "Error: Failed to authenticate with CapRover"
  echo "$LOGIN_RESPONSE" | jq . 2>/dev/null || echo "$LOGIN_RESPONSE"
  rm -f "$TAR_FILE"
  exit 1
fi

# Deploy
echo "Uploading..."
RESULT=$(curl -s -X POST "$CAPROVER_URL/api/v2/user/apps/appData/$CAPROVER_APP" \
  -H "x-namespace: captain" \
  -H "x-captain-auth: $TOKEN" \
  -F "sourceFile=@$TAR_FILE")

rm -f "$TAR_FILE"

STATUS=$(echo "$RESULT" | jq -r '.status // empty')
if [ "$STATUS" = "100" ]; then
  echo "Deploy complete!"
else
  echo "Deploy failed:"
  echo "$RESULT" | jq . 2>/dev/null || echo "$RESULT"
  exit 1
fi
